import{r as e,j as a,u as t,H as s,P as n}from"./vendor-DeShHRvC.js";import{U as i,u as r,a as o,b as c,c as l,d,R as m,S as h,e as u,f as g,E as p}from"./index-D9TadXBX.js";import"./vendor-jspdf-CcCK2Zy6.js";import"./vendor-@react-oauth-Di4DNcpW.js";import"./http-VSpmzgsF.js";import"./vendor-matter-js-BjVipDty.js";import"./vendor-ogl-YOJCSol6.js";import"./vendor-motion-BfReZoSV.js";import"./vendor-gsap-CSqFbIEy.js";function v({conversations:t=[],activeConversationId:s=null,onSelect:n=()=>{},characters:i=[]}){if(!t||0===t.length)return a.jsxs("div",{className:"conversation-list empty",children:[a.jsx("p",{children:"No conversations yet"}),a.jsx("p",{className:"text-sm",children:"Start a new conversation to begin chatting"})]});const r=e.useMemo(()=>t.map(e=>{const a=e.id===s,t=e.lastMessage||{},n=e.updated_at||e.created_at?new Date(e.updated_at||e.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):t.timestamp?new Date(t.timestamp).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"",r=i.find(a=>a.id===e.model_type),o=r?r.name:e.model_type||"Unknown";return{...e,isActive:a,timestamp:n,characterName:o,preview:t.content?t.content.substring(0,50):e.message_count>0?`${e.message_count} messages`:"No messages yet",hasMore:t.content&&t.content.length>50}}),[t,s,i]);return a.jsxs("div",{className:"conversation-list",children:[a.jsx("div",{className:"conversation-list-header",children:a.jsx("h3",{children:"Conversations"})}),a.jsx("div",{className:"conversation-list-container",children:r.map(e=>a.jsxs("button",{className:"conversation-item "+(e.isActive?"active":""),onClick:()=>n(e.id),title:e.title||e.characterName,children:[a.jsxs("div",{className:"conversation-header",children:[a.jsx("span",{className:"conversation-title",children:e.title||`Chat with ${e.characterName}`}),a.jsx("span",{className:"conversation-time",children:e.timestamp})]}),a.jsxs("div",{className:"conversation-preview",children:[e.preview,e.hasMore?"...":""]})]},e.id))})]})}function x({characters:t=[],activeCharacterId:s=null,onSelect:n=()=>{}}){var i;const r=e.useMemo(()=>t.find(e=>e.id===s)||t[0],[t,s]),o=e.useCallback(e=>{n(e)},[n]);return t&&0!==t.length?a.jsxs("div",{className:"character-selector",children:[r&&a.jsxs("div",{className:"active-character",children:[a.jsx("div",{className:"character-avatar",children:r.avatar?a.jsx("img",{src:r.avatar,alt:r.name}):a.jsx("div",{className:"avatar-placeholder",children:(null==(i=r.name)?void 0:i.charAt(0))||"C"})}),a.jsxs("div",{className:"character-info",children:[a.jsx("h3",{className:"character-name",children:r.name}),a.jsx("p",{className:"character-bio",children:r.bio||"No description"})]})]}),t.length>1&&a.jsxs("div",{className:"character-list",children:[a.jsx("div",{className:"character-list-header",children:a.jsx("span",{children:"Other Characters"})}),a.jsx("div",{className:"character-options",children:t.filter(e=>e.id!==s).map(e=>{var t;return a.jsxs("button",{className:"character-option",onClick:()=>o(e.id),title:e.name,children:[a.jsx("div",{className:"option-avatar",children:e.avatar?a.jsx("img",{src:e.avatar,alt:e.name}):a.jsx("div",{className:"avatar-placeholder",children:(null==(t=e.name)?void 0:t.charAt(0))||"C"})}),a.jsxs("div",{className:"option-info",children:[a.jsx("div",{className:"option-name",children:e.name}),a.jsx("div",{className:"option-bio",children:e.bio||"No description"})]})]},e.id)})})]})]}):a.jsx("div",{className:"character-selector empty",children:a.jsx("p",{children:"No characters available"})})}function j(){const s=t(),{startTransition:n}=r(),[u,g]=e.useState(!1),[p,j]=e.useState(window.innerWidth<768),b=function(){const a=e.useContext(i),[t,s]=e.useState(window.innerWidth<768);return a?(e.useEffect(()=>{const e=()=>{const e=window.innerWidth<768;s(e),a.setMobileView(e),e&&a.sidebarOpen&&a.setSidebarOpen(!1)};return window.addEventListener("resize",e),e(),()=>window.removeEventListener("resize",e)},[a]),{isOpen:a.sidebarOpen,isMobile:a.isMobileView,isTablet:window.innerWidth>=768&&window.innerWidth<1024,isDesktop:window.innerWidth>=1024,toggle:a.toggleSidebar,open:()=>a.setSidebarOpen(!0),close:()=>a.setSidebarOpen(!1)}):(console.warn("[useSidebar] UIContext not yet available, using safe defaults"),{isOpen:!1,isMobile:t,isTablet:!1,isDesktop:!1,toggle:()=>console.warn("[useSidebar] Toggle called before context ready"),open:()=>console.warn("[useSidebar] Open called before context ready"),close:()=>console.warn("[useSidebar] Close called before context ready")})}(),{logout:N}=o(),{conversations:f,activeConversationId:y,setActiveConversation:w,startConversation:C,fetchMessages:S}=c(),{characters:k,activeCharacterId:I,selectCharacter:M}=l(),E=d("character-creator"),A=d("settings");e.useEffect(()=>{const e=()=>{const e=window.innerWidth<768;j(e),e||g(!1)};return window.addEventListener("resize",e),e(),()=>window.removeEventListener("resize",e)},[]),p||(null==b||b.isOpen);const T=p,L=e=>{e&&(e.preventDefault(),e.stopPropagation()),console.log("[Hamburger] Toggle triggered! Current:",u),g(e=>{const a=!e;return console.log("[Hamburger] Sidebar is now:",a?"OPEN":"CLOSED"),a})};return a.jsxs(a.Fragment,{children:[T&&!u&&a.jsx("button",{className:"sidebar-toggle floating",onClick:L,onTouchEnd:e=>{e.preventDefault(),console.log("[Hamburger] Touch detected!"),L()},onMouseDown:()=>console.log("[Hamburger] Mouse down"),onTouchStart:e=>{console.log("[Hamburger] Touch start"),e.stopPropagation()},"aria-label":"Open navigation menu","aria-expanded":!1,"aria-controls":"sidebar-navigation",type:"button",style:{touchAction:"manipulation",WebkitTapHighlightColor:"rgba(6, 182, 212, 0.2)",userSelect:"none",WebkitUserSelect:"none"},children:"â˜°"}),T&&u&&a.jsx("div",{className:"sidebar-overlay",onClick:()=>{console.log("[Overlay] Clicked, closing sidebar"),g(!1)},style:{position:"fixed",inset:0,background:"rgba(0, 0, 0, 0.5)",zIndex:999,backdropFilter:"blur(4px)"}}),a.jsxs("nav",{id:"sidebar-navigation",className:"sidebar "+(u?"open":"closed"),children:[a.jsxs("div",{className:"sidebar-header",children:[a.jsxs("h2",{className:"sidebar-logo",style:{fontSize:"1.5rem",cursor:"pointer"},onClick:()=>{n(()=>{s("/")})},title:"Go to homepage",children:["Justlay.",a.jsx(m,{texts:["Me","You","Her","Him","Yourself","Everyone","Someone","Back","Down","Low"],mainClassName:"rotating-brand-highlight",splitBy:"words",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},rotationInterval:2e3})]}),T&&a.jsx("button",{className:"close-btn",onClick:()=>{console.log("[Sidebar] Close button clicked"),g(!1)},onTouchEnd:e=>{e.preventDefault(),console.log("[Sidebar] Close button touch"),g(!1)},style:{touchAction:"manipulation"},children:"âœ•"})]}),a.jsx(x,{characters:k,activeCharacterId:I,onSelect:async e=>{M(e);const a=f.filter(a=>a.model_type===e);if(a.length>0){const s=a[0];console.log(`[Sidebar] Resuming conversation ${s.id} with character ${e}`),w(s.id);try{await S(s.id)}catch(t){console.error("Failed to load conversation messages:",t)}}else{console.log(`[Sidebar] No existing conversations for character ${e}, creating new one`);try{await C(e)}catch(t){console.error("Failed to start conversation:",t)}}}}),a.jsx(v,{conversations:I?f.filter(e=>e.model_type===I):f,characters:k,activeConversationId:y,onSelect:e=>{w(e),S(e).catch(e=>{console.error("Failed to load messages:",e)}),T&&g(!1)}}),a.jsxs("div",{className:"sidebar-actions",children:[a.jsx(h,{className:"action-card",spotlightColor:"rgba(6, 182, 212, 0.3)",spotlightSize:200,children:a.jsx("button",{className:"action-btn primary",onClick:()=>{E.openModal(),T&&g(!1)},title:"Create new character",children:a.jsx("span",{className:"btn-text",children:"New Character"})})}),a.jsx(h,{className:"action-card",spotlightColor:"rgba(139, 92, 246, 0.25)",spotlightSize:200,children:a.jsx("button",{className:"action-btn secondary",onClick:async()=>{if(I)try{await C(I)}catch(e){console.error("Failed to start new conversation:",e)}},disabled:!I,title:"Start new conversation with selected character",children:a.jsx("span",{className:"btn-text",children:"New Conversation"})})}),a.jsx(h,{className:"action-card",spotlightColor:"rgba(255, 255, 255, 0.2)",spotlightSize:200,children:a.jsx("button",{className:"action-btn secondary black-mirror-btn",onClick:()=>{T&&g(!1),console.log("[Sidebar] Grey Mirror button clicked, forcing page reload"),window.location.href="/grey-mirror"},title:"Analyze relationships",children:a.jsx("span",{className:"btn-text",children:"The Grey Mirror"})})})]}),a.jsxs("div",{className:"sidebar-footer",children:[a.jsx("button",{className:"footer-btn",onClick:()=>{A.openModal(),T&&g(!1)},children:"Settings"}),a.jsx("button",{className:"footer-btn",onClick:()=>{N(),localStorage.removeItem("authToken"),localStorage.removeItem("refreshToken"),s("/"),setTimeout(()=>{n("/")},10)},children:"Logout"})]})]})]})}const b=e.memo(function({message:e={},variant:t="user"}){const{id:s,content:n="",timestamp:i,senderName:r="",senderAvatar:o="",metadata:c={}}=e,l=i?new Date(i).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):"",d=n.split("\n").length>1;return a.jsxs("div",{className:`message message-${t}`,children:["character"===t&&o&&a.jsx("div",{className:"message-avatar",children:a.jsx("img",{src:o,alt:r})}),a.jsxs("div",{className:"message-bubble",children:["character"===t&&r&&a.jsx("div",{className:"message-sender",children:r}),a.jsx("div",{className:"message-content "+(d?"multiline":""),children:n}),l&&a.jsx("div",{className:"message-time",children:l})]}),"user"===t&&a.jsxs("div",{className:"message-actions",children:[a.jsx("button",{className:"action-btn",title:"Copy message",children:"ðŸ“‹"}),a.jsx("button",{className:"action-btn",title:"Delete message",children:"ðŸ—‘ï¸"})]})]})},function(e,a){var t,s,n,i,r,o;return(null==(t=e.message)?void 0:t.id)===(null==(s=a.message)?void 0:s.id)&&(null==(n=e.message)?void 0:n.content)===(null==(i=a.message)?void 0:i.content)&&(null==(r=e.message)?void 0:r.timestamp)===(null==(o=a.message)?void 0:o.timestamp)&&e.variant===a.variant}),N=200;const f=e.memo(function({messages:t=[],isLoading:s=!1,activeCharacterId:n=null}){const i=e.useRef(null),r=e.useRef(null),o=e.useMemo(()=>t.length<=N?t:t.slice(-200),[t]),c=Math.max(0,t.length-N);return e.useEffect(()=>{r.current&&o.length>0&&r.current.scrollIntoView({behavior:"smooth"})},[o.length]),s&&0===t.length?a.jsx("div",{className:"message-list loading",children:a.jsxs("div",{className:"loading-state",children:[a.jsx("div",{className:"spinner"}),a.jsx("p",{children:"Loading messages..."})]})}):0===t.length?a.jsx("div",{className:"message-list empty",children:a.jsxs("div",{className:"empty-state",children:[a.jsx("p",{children:a.jsx(u,{speed:5,children:"No messages yet"})}),a.jsx("p",{className:"text-sm",children:a.jsx(u,{speed:5,children:"Start the conversation by sending a message"})})]})}):a.jsx("div",{className:"message-list",ref:i,children:a.jsxs("div",{className:"message-list-container",children:[c>0&&a.jsxs("div",{className:"hidden-messages-indicator",children:[a.jsxs("p",{className:"text-sm text-gray-400",children:["ðŸ“œ ",c," older message",c>1?"s":""," not shown (showing last ",N,")"]}),a.jsx("p",{className:"text-xs text-gray-500",children:"Scroll performance optimized for long conversations"})]}),o.map(e=>a.jsx(b,{message:e,variant:e.senderId===n?"character":"user"},e.id||e.timestamp)),a.jsx("div",{ref:r})]})})},function(e,a){var t,s;return e.messages.length===a.messages.length&&e.isLoading===a.isLoading&&e.activeCharacterId===a.activeCharacterId&&(null==(t=e.messages[e.messages.length-1])?void 0:t.id)===(null==(s=a.messages[a.messages.length-1])?void 0:s.id)});function y({activeConversationId:t=null,activeCharacterId:s=null,activeCharacter:n=null}){const[i,r]=e.useState(""),[o,l]=e.useState(!1),[d,m]=e.useState(null),[h,u]=e.useState(null),p=e.useRef(null),v=e.useRef(null),{sendMessage:x}=c(),j=g();e.useEffect(()=>{p.current&&(p.current.style.height="auto",p.current.style.height=Math.min(p.current.scrollHeight,120)+"px")},[i]);const b=async()=>{var e,a,o,c,h;if(i.trim()||d)if(t)if(0!==i.trim().length||d){l(!0);try{let l=null;if(d){const e=new FormData;e.append("file",d),e.append("conversationId",t);const a=await fetch("/api/upload",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:e});if(!a.ok){const e=(await a.json().catch(()=>({}))).message||`Upload failed with status ${a.status}`;throw new Error(e)}const s=await a.json();if(!s.fileUrl&&!s.url)throw new Error("Upload succeeded but no file URL returned - invalid server response");l=s.fileUrl||s.url}const g=n?{character:n.id||s,characterName:n.name,isCustomCharacter:!1!==n.isCustom,customCharacterConfig:{systemPrompt:n.system_prompt||n.systemPrompt||n.personality,personality:n.personality,description:n.description,model:(null==(e=n.config)?void 0:e.model)||"sushruth/solar-uncensored:latest",temperature:parseFloat(null==(a=n.config)?void 0:a.temperature)||.85,top_p:parseFloat(null==(o=n.config)?void 0:o.top_p)||.95,max_tokens:parseInt(null==(c=n.config)?void 0:c.max_tokens,10)||250,repeat_penalty:parseFloat(null==(h=n.config)?void 0:h.repeat_penalty)||1.1}}:{};await x(i.trim()||"[Image attachment]",l,g),r(""),m(null),u(null),v.current&&(v.current.value=""),p.current&&(p.current.style.height="auto")}catch(g){console.error("Failed to send message:",g);const e=(null==g?void 0:g.message)||"Failed to send message";j.error(e)}finally{l(!1)}}else j.warning("Message cannot be empty");else j.error("No conversation selected");else j.warning("Please enter a message or attach a file")};return a.jsxs("div",{className:"input-area",children:[h&&a.jsxs("div",{className:"file-preview-container",children:[a.jsxs("div",{className:"file-preview",children:[a.jsx("img",{src:h,alt:"Attached file preview"}),a.jsx("button",{className:"remove-file-btn",onClick:()=>{m(null),u(null),v.current&&(v.current.value="")},title:"Remove attachment",children:"âœ•"})]}),a.jsxs("div",{className:"file-info",children:[a.jsx("span",{className:"file-name",children:null==d?void 0:d.name}),a.jsxs("span",{className:"file-size",children:[(null==d?void 0:d.size)?(d.size/1024).toFixed(1):"0"," KB"]})]})]}),a.jsxs("div",{className:"input-container",children:[a.jsx("textarea",{ref:p,className:"message-input",placeholder:"Type your message... (Ctrl+Enter to send)",value:i,onChange:e=>r(e.target.value),onKeyDown:e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),b()),"Enter"===e.key&&!e.ctrlKey&&e.metaKey},disabled:o||!t,rows:1}),a.jsxs("div",{className:"input-actions",children:[a.jsx("input",{ref:v,type:"file",accept:"image/jpeg,image/png,image/gif,image/webp",onChange:e=>{var a;const t=null==(a=e.target.files)?void 0:a[0];if(!t)return;if(t.size>5242880)return void j.error("File size exceeds 5MB limit");if(!["image/jpeg","image/png","image/gif","image/webp"].includes(t.type))return void j.error("Only image files (JPG, PNG, GIF, WebP) are supported");m(t);const s=new FileReader;s.onload=e=>{u(e.target.result)},s.readAsDataURL(t)},style:{display:"none"},"aria-label":"Attach file"}),a.jsx("button",{className:"action-button secondary",title:"Attach file (images only, max 5MB)",onClick:()=>{var e;return null==(e=v.current)?void 0:e.click()},disabled:o||!t||d,children:"ðŸ“Ž"}),a.jsx("button",{className:"action-button primary",onClick:b,disabled:o||!i.trim()&&!d||!t,title:"Send message (Ctrl+Enter)",children:o?"â³":"â†’"})]})]}),a.jsxs("div",{className:"input-hint",children:[a.jsx("span",{className:"hint-text",children:"Ctrl+Enter to send"}),d&&a.jsxs("span",{className:"hint-text",children:[" Â· File attached: ",d.name]})]})]})}function w({characterName:e="Character"}){return a.jsx("div",{className:"typing-indicator-container",children:a.jsxs("div",{className:"typing-message",children:[a.jsxs("div",{className:"typing-dots",children:[a.jsx("span",{className:"dot"}),a.jsx("span",{className:"dot"}),a.jsx("span",{className:"dot"})]}),a.jsxs("span",{className:"typing-label",children:[e," is typing..."]})]})})}function C(){var e;t();const{startTransition:s}=r(),{activeConversationId:n,messages:i,isLoadingMessages:m,typingIndicator:h}=c(),{characters:p,activeCharacterId:v}=l();o();const x=d("settings");d("premium-paywall");const j=g(),b=p.find(e=>e.id===v);return n?a.jsxs("div",{className:"chat-area",children:[a.jsxs("div",{className:"chat-header",children:[a.jsxs("div",{className:"header-character",children:[a.jsx("div",{className:"character-avatar-mini",children:(null==b?void 0:b.avatar)?a.jsx("img",{src:b.avatar,alt:null==b?void 0:b.name}):a.jsx("div",{className:"avatar-placeholder",children:(null==(e=null==b?void 0:b.name)?void 0:e.charAt(0))||"C"})}),a.jsxs("div",{className:"header-info",children:[a.jsx("h2",{children:(null==b?void 0:b.name)||"Character"}),a.jsx("p",{className:"header-status",children:"Online"})]})]}),a.jsxs("div",{className:"header-actions",children:[a.jsx("button",{className:"header-btn",title:"Character info",onClick:()=>{j.info("Character information panel coming soon!")},children:"â„¹ï¸"}),a.jsx("button",{className:"header-btn",title:"Settings",onClick:()=>{x.openModal()},children:"âš™ï¸"})]})]}),a.jsx(f,{messages:i,isLoading:m,activeCharacterId:v}),h.isVisible&&a.jsx(w,{characterName:h.characterName}),a.jsx(y,{activeConversationId:n,activeCharacterId:v,activeCharacter:b}),a.jsx("button",{className:"floating-black-mirror-btn",onClick:()=>{console.log("[ChatArea] Grey Mirror button clicked, forcing page reload"),window.location.href="/grey-mirror"},title:"The Grey Mirror Analysis","aria-label":"Open The Grey Mirror Analysis",children:"ðŸªž"})]}):a.jsx("div",{className:"chat-area empty",children:a.jsxs("div",{className:"empty-state",children:[a.jsx("div",{className:"empty-icon",children:"ðŸ’¬"}),a.jsx("h2",{children:a.jsx(u,{speed:5,children:"Select a conversation to start"})}),a.jsx("p",{children:a.jsx(u,{speed:5,children:"Choose a conversation from the sidebar or create a new one"})})]})})}function S(){const[t,s]=e.useState(window.innerWidth<768),{fetchConversations:n}=c(),{fetchCharacters:i}=l(),{isAuthenticated:r}=o();return e.useEffect(()=>{const e=()=>{s(window.innerWidth<768)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),e.useEffect(()=>{r&&(n().catch(e=>{console.warn("Failed to load conversations:",e.message)}),i().catch(e=>{console.warn("Failed to load characters:",e.message)}))},[r,n,i]),a.jsxs("div",{className:"chat-layout",children:[a.jsx(j,{}),a.jsx(C,{})]})}function k(){return a.jsxs(p,{fallback:({error:e,reset:t})=>a.jsx("div",{className:"error-container",children:a.jsxs("div",{className:"error-content",children:[a.jsx("h2",{children:"ðŸ˜” Chat Error"}),a.jsx("p",{children:"We encountered an issue loading your conversations."}),a.jsx("p",{className:"error-hint",children:"This might be a temporary network problem."}),(null==e?void 0:e.circuitOpen)&&a.jsx("p",{className:"circuit-message",children:"âš¡ Too many failed requests. Please wait a moment before trying again."}),a.jsx("button",{onClick:t,className:"retry-button",children:"Try Again"})]})}),children:[a.jsxs(s,{children:[a.jsx("title",{children:"Chat with AI - JustLayMe"}),a.jsx("meta",{name:"description",content:"Chat with advanced AI without restrictions. Enjoy unfiltered conversations with custom characters powered by cutting-edge language models."}),a.jsx("link",{rel:"canonical",href:"https://justlay.me/chat"}),a.jsx("meta",{property:"og:title",content:"Chat with AI - JustLayMe"}),a.jsx("meta",{property:"og:description",content:"Chat with advanced AI without restrictions. Enjoy unfiltered conversations with custom characters powered by cutting-edge language models."}),a.jsx("meta",{property:"og:url",content:"https://justlay.me/chat"}),a.jsx("meta",{property:"og:type",content:"website"}),a.jsx("meta",{property:"og:image",content:"https://justlay.me/og-image.jpg"}),a.jsx("meta",{property:"og:image:width",content:"1200"}),a.jsx("meta",{property:"og:image:height",content:"630"}),a.jsx("meta",{name:"twitter:card",content:"summary_large_image"}),a.jsx("meta",{name:"twitter:title",content:"Chat with AI - JustLayMe"}),a.jsx("meta",{name:"twitter:description",content:"Chat with advanced AI without restrictions. Enjoy unfiltered conversations with custom characters powered by cutting-edge language models."}),a.jsx("meta",{name:"twitter:image",content:"https://justlay.me/twitter-image.jpg"})]}),a.jsx("div",{className:"chat-page",children:a.jsx(S,{})})]})}k.propTypes={children:n.node};export{k as default};
